## ゲーム制作講座
***
シングルトンの話をするのに必要不可欠な知識がコピーコンストラクタと代入演算子である。  
これらは自分で定義しなかった場合勝手に定義されてしまうやや厄介なものである。  

# コピーコンストラクタ

コピーコンストラクタとは、クラスのインスタンスを生成するときに呼ばれるコンストラクタの1つで、引数に自分自身のconst参照型を入れることでメンバをコピーしたインスタンスを生成する。  

```cpp
class Hoge {
public:
    Hoge() {} //通常のコンストラクタ
    Hoge(const Hoge &o) {} //コピーコンストラクタ
    int a;
};

int main() {
    Hoge hoge; //通常のコンストラクタ
    Hoge hoge2(hoge); //コピーコンストラクタ
    Hoge hoge3 = hoge; //コピーコンストラクタ
    return 0;
}
```

コピーコンストラクタが呼ばれるタイミングは上の例のような初期化時と、値渡しの関数が呼ばれたときが主である。  

```cpp
class Hoge;

void f(Hoge hoge);

int main() {
    Hoge hoge; //通常のコンストラクタ
    f(hoge); //コピーコンストラクタ
}
```

コピーコンストラクタは呼びたくない場合がほとんどなので、基本的に関数の引数に必要なときは参照型を利用する。  
参照型の初期化時は実体を生成しているわけではないのでコピーコンストラクタは呼ばれない。  
```cpp
class Hoge;

void f(const Hoge &hoge);

int main() {
    Hoge hoge;
    f(hoge);
}
```

# 代入演算子

代入演算子は=で表される演算子で、コピーコンストラクタと同様勝手に定義されてメンバのコピーを行う。  

```cpp
class Hoge {
public:
    Hoge &operator= (const Hoge &o) {}
};
```

# コピーを禁止する

インスタンスのコピーはこれらをprivateメンバにすれば大半は防ぐことができる。  

```cpp
class Hoge {
private:
    Hoge(const Hoge&) {}
    Hoge &operator= (const Hoge &) {}
public:
    Hoge() {}
};
```

# delete宣言

C++にはdelete宣言というものがある。  
クラスを定義したときに暗黙に定義されるコンストラクタやデストラクタなどを定義させないようにできる。  
書き方は=deleteとするだけである。  
```cpp
class Hoge {
private:
    Hoge(const Hoge&) = delete;
    Hoge &operator= (const Hoge &) = delete;
public:
    Hoge() {}
};
```

こうすることでコピーの発生をコンパイル段階ではじくことができる。  

# コピーを禁止する理由

インスタンスのコピーを禁止する理由はいくつかある。  
そのなかでも、ポインタ変数をメンバに持つクラスについて紹介する。  

下のクラスを見てほしい

```cpp
class Hoge {
public:
    Hoge(int a) { p = new int(a); }
    ~Hoge() { delete p; }
    int *p;
};
```

コンストラクタでnewしてデストラクタでdeleteしている。

デフォルトのコピーコンストラクタや代入演算子はメンバのコピーのみを行うため、一度コピーが発生してしまうとポインタ変数の指し示す先が同じインスタンスが2つ生成されてしまう。  
その後デストラクタで同じポインタを二度deleteしてしまうためエラーになってしまう。  

コピーコンストラクタと代入演算子をコピーが発生しても問題ないように自分で定義してあげれば解決できるが、コピーすることが必要ない場合がほとんどであるため禁止してしまうのが手っ取り早いだろう。  

# 練習問題

次のクラスのコピーコンストラクタと代入演算子をprivateメンバにせよ。  
関数の中身は特に指定しない。  
```cpp
class MyClass {
public:
    MyClass(int x, int y) : 
        x(x),
        y(y)
    {
    }
    int x;
    int y;
};
```